{% extends "base.html" %}

{% block title %}提醒事項 | 工具箱 Web{% endblock %}

{% block extra_css %}
<style>
    .reminder-dashboard {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .reminder-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
        padding-bottom: 80px;
    }

    .reminder-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 20px;
        position: relative;
        transition: transform 0.2s, background 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 160px;
    }

    .reminder-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.08);
    }

    .reminder-card.inactive {
        opacity: 0.6;
        filter: grayscale(0.8);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
    }

    .reminder-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .reminder-time {
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent-color);
        margin: 10px 0;
        font-family: 'SF Mono', 'Roboto Mono', monospace;
    }

    .reminder-meta {
        font-size: 0.9rem;
        color: var(--text-secondary);
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-line {
        color: #00B900;
        background: rgba(0, 185, 0, 0.15);
    }

    .badge-email {
        color: #EA4335;
        background: rgba(234, 67, 53, 0.15);
    }

    /* Switch Component */
    .switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.2);
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked+.slider {
        background-color: var(--accent-color);
    }

    input:checked+.slider:before {
        transform: translateX(20px);
    }

    input:checked+.slider:before {
        transform: translateX(20px);
    }

    /* Weekday Selector */
    .weekday-selector {
        display: none;
        gap: 8px;
        margin-top: 10px;
        justify-content: space-between;
    }

    .weekday-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
        font-weight: 600;
        user-select: none;
    }

    .weekday-btn:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .weekday-btn.active {
        background: var(--accent-color);
        color: #000;
        border-color: var(--accent-color);
        box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.3);
    }

    .action-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: 0.2s;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .delete-btn:hover {
        color: #ff4d4d;
        background: rgba(255, 77, 77, 0.1);
    }

    .card-actions {
        display: flex;
        gap: 5px;
        margin-top: auto;
        justify-content: flex-end;
    }

    .add-fab {
        position: fixed;
        bottom: 90px;
        /* Above bottom nav */
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 28px;
        background: var(--accent-color);
        color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
        cursor: pointer;
        z-index: 100;
        transition: transform 0.2s;
    }

    .add-fab:hover {
        transform: scale(1.05);
    }

    /* Premium Modal Styles */
    .modal {
        /* Override Bootstrap defaults to use Flexbox centering */
        padding: 0 !important;
        /* Avoid padding shifting content */
    }

    .modal.show {
        display: flex !important;
        align-items: center;
        justify-content: center;
        padding: 0 10px;
        /* Safety padding */
    }

    .modal-dialog {
        width: 100%;
        max-width: 450px;
        /* Constrain width */
        margin: auto;
        /* Flex constraints for full height support */
        display: flex;
        flex-direction: column;
        max-height: 95vh;
        /* Limit dialog height to viewport */
    }

    .modal-content {
        background: rgba(30, 30, 30, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        border-radius: 24px;
        margin: auto;
        /* Ensure content fills dialog and flexes */
        display: flex;
        flex-direction: column;
        max-height: 100%;
    }

    /* Mobile Fullscreen Modal */
    @media (max-width: 576px) {
        .modal-dialog {
            max-width: 100%;
            margin: 0;
            height: 100%;
            max-height: 100%;
            border-radius: 0;
        }

        .modal-content {
            border-radius: 0;
            height: 100%;
            border: none;
        }

        .modal.show {
            padding: 0 !important;
        }
    }

    .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        padding: 24px 24px 16px;
        display: flex;
        justify-content: center;
        flex-shrink: 0;
        /* Keep header size fixed */
        position: relative;
    }

    .modal-title {
        font-weight: 700;
        font-size: 1.5rem;
        background: linear-gradient(135deg, #fff 0%, #aaa 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        width: 100%;
        text-align: center;
    }

    .close {
        position: absolute;
        right: 24px;
        top: 24px;
        z-index: 10;
        padding: 0;
        margin: 0;
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        /* Scroll internally */
        flex: 1;
        /* Take remaining space */
        min-height: 0;
        /* Firefox fix */
    }

    .modal-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        padding: 16px 24px 24px;
        display: flex;
        justify-content: space-between;
        /* Cancel left, Save right */
        align-items: center;
        flex-shrink: 0;
        /* Keep footer buttons visible */
    }

    /* Form Controls */
    .form-group label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 8px;
        font-weight: 600;
    }

    .form-control,
    .form-select {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus,
    .form-select:focus {
        background: rgba(0, 0, 0, 0.4);
        color: white;
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.25);
        border-color: var(--accent-color);
    }

    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.3);
    }

    /* Custom Checkboxes */
    .custom-control-label {
        padding-left: 2rem;
        cursor: pointer;
        padding-top: 2px;
    }

    .custom-control-label::before {
        top: 0.25rem;
        left: 0;
        width: 1.25rem;
        height: 1.25rem;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
    }

    .custom-control-input:checked~.custom-control-label::before {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
    }

    /* Buttons */
    .btn {
        border-radius: 12px;
        padding: 10px 24px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: transform 0.1s;
    }

    .btn:active {
        transform: scale(0.98);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: rgba(255, 255, 255, 0.8);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .btn-primary {
        background: var(--accent-color);
        border: none;
        box-shadow: 0 4px 15px rgba(var(--accent-rgb), 0.4);
    }

    .btn-primary:hover {
        background: var(--accent-color);
        filter: brightness(1.1);
        box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.6);
    }

    /* Toastr Custom Style */
    #toast-container>.toast {
        background-color: rgba(30, 30, 30, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        opacity: 1 !important;
    }

    #toast-container>.toast-success {
        border-left: 5px solid #00B900;
        background-image: none !important;
        /* Remove default icon if needed, or keep */
    }

    #toast-container>.toast-error {
        border-left: 5px solid #EA4335;
        background-image: none !important;
    }

    #toast-container>.toast-message {
        color: #fff !important;
        font-weight: 500;
    }
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="reminder-dashboard">
    <div class="dashboard-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
            <span class="material-icons" style="color: var(--accent-color);">notifications_active</span>
            提醒事項
        </h2>
    </div>

    {% if not reminders %}
    <div style="text-align: center; margin-top: 100px; color: var(--text-secondary);">
        <span class="material-icons"
            style="font-size: 4rem; opacity: 0.5; margin-bottom: 20px;">notifications_off</span>
        <p>目前沒有任何提醒</p>
        <button class="btn btn-primary" onclick="openAddModal()">立即新增</button>
    </div>
    {% else %}
    <div class="reminder-grid">
        {% for r in reminders %}
        <div class="reminder-card {% if not r.is_active %}inactive{% endif %}" id="card-{{ r.id }}">
            <div class="card-header">
                <label class="switch">
                    <input type="checkbox" onchange="toggleReminder({{ r.id }})" {% if r.is_active %}checked{% endif %}>
                    <span class="slider"></span>
                </label>
                <div class="card-actions">
                    <button class="action-btn" onclick="openEditModal({{ r.id }})">
                        <span class="material-icons">edit</span>
                    </button>
                    <button class="action-btn delete-btn" onclick="deleteReminder({{ r.id }})">
                        <span class="material-icons">delete</span>
                    </button>
                </div>
            </div>

            <div>
                <h3 class="reminder-title">{{ r.title }}</h3>
                <div class="reminder-time">{{ r.remind_time }}</div>

                <div class="reminder-meta">
                    <span class="badge">
                        <span class="material-icons" style="font-size: 14px;">repeat</span>
                        {% if r.frequency == 'once' %}單次
                        {% elif r.frequency == 'daily' %}每天
                        {% elif r.frequency == 'weekly' %}每週
                        {% endif %}
                    </span>

                    {% set methods = r.notify_method | tojson %} <!-- Safe parse string JSON -->
                    {% if 'line' in r.notify_method %}
                    <span class="badge badge-line"><span class="material-icons" style="font-size: 14px;">chat</span>
                        Line</span>
                    {% endif %}
                    {% if 'email' in r.notify_method %}
                    <span class="badge badge-email"><span class="material-icons" style="font-size: 14px;">email</span>
                        Mail</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="add-fab" onclick="openAddModal()">
        <span class="material-icons">add</span>
    </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="reminderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="modalTitle">新增提醒</h5>

            </div>
            <div class="modal-body">
                <form id="reminderForm">
                    <input type="hidden" id="reminderId">
                    <div class="form-group">
                        <label>標題</label>
                        <input type="text" class="form-control" id="title" required placeholder="例如：吃藥、繳費">
                    </div>

                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label>時間</label>
                                <input type="time" class="form-control" id="remindTime" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label>頻率</label>
                                <select class="form-control form-select" id="frequency" onchange="toggleDateInput()">
                                    <option value="once">單次</option>
                                    <option value="daily">每天</option>
                                    <option value="weekly">每週</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" id="weekdayGroup" style="display: none;">
                        <label>重複日 (可多選)</label>
                        <div class="weekday-selector" id="weekdaySelector" style="display: flex;">
                            <div class="weekday-btn" data-day="0">一</div>
                            <div class="weekday-btn" data-day="1">二</div>
                            <div class="weekday-btn" data-day="2">三</div>
                            <div class="weekday-btn" data-day="3">四</div>
                            <div class="weekday-btn" data-day="4">五</div>
                            <div class="weekday-btn" data-day="5">六</div>
                            <div class="weekday-btn" data-day="6">日</div>
                        </div>
                    </div>

                    <div class="form-group" id="dateGroup">
                        <label>日期 (單次)</label>
                        <input type="date" class="form-control" id="remindDate">
                    </div>

                    <div class="form-group">
                        <label>備註 (選填)</label>
                        <textarea class="form-control" id="description" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveReminder()">儲存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    // Move modal to body to ensure it is positioned relative to the viewport, not a parent container
    $(document).ready(function () {
        $('#reminderModal').appendTo("body");
    });

    // Initialize current date for date picker
    document.getElementById('remindDate').valueAsDate = new Date();

    // Weekday Button Click Logic
    $(document).on('click', '.weekday-btn', function () {
        $(this).toggleClass('active');
    });

    function toggleDateInput() {
        const freq = document.getElementById('frequency').value;
        const dateGroup = document.getElementById('dateGroup');
        const weekdayGroup = document.getElementById('weekdayGroup');

        // Reset states
        dateGroup.style.display = 'none';
        weekdayGroup.style.display = 'none';

        if (freq === 'once') {
            dateGroup.style.display = 'block';
        } else if (freq === 'weekly') {
            weekdayGroup.style.display = 'block';
        } else {
            document.getElementById('remindDate').value = '';
        }
    }

    function openAddModal() {
        document.getElementById('modalTitle').innerText = '新增提醒';
        document.getElementById('reminderForm').reset();
        document.getElementById('reminderId').value = '';
        document.getElementById('frequency').value = 'once';
        document.getElementById('remindDate').valueAsDate = new Date();
        $('.weekday-btn').removeClass('active'); // Reset weekdays
        toggleDateInput();
        $('#reminderModal').modal('show');
    }

    // Load data into modal for editing is tricky without passing full JSON object to template.
    // For simplicity, we can fetch detailed data or just use data attributes if available.
    // Let's implement a simple client-side data store from the rendered list.
    const remindersData = {
        {% for r in reminders %}
    { { r.id } }: {
        title: "{{ r.title }}",
            description: `{{ r.description or '' }}`,
                time: "{{ r.remind_time }}",
                    date: "{{ r.remind_date or '' }}",
                        freq: "{{ r.frequency }}",
                            weekdays: { { r.weekdays or '[]' } }
    },
    {% endfor %}
    };

    function openEditModal(id) {
        const data = remindersData[id];
        if (!data) return;

        document.getElementById('modalTitle').innerText = '編輯提醒';
        document.getElementById('reminderId').value = id;
        document.getElementById('title').value = data.title;
        document.getElementById('description').value = data.description;
        document.getElementById('remindTime').value = data.time;
        document.getElementById('frequency').value = data.freq;

        if (data.date && data.date !== 'None') {
            document.getElementById('remindDate').value = data.date;
        }

        // Reset and Set Weekdays
        $('.weekday-btn').removeClass('active');
        if (data.weekdays && Array.isArray(data.weekdays)) {
            data.weekdays.forEach(day => {
                $(`.weekday-btn[data-day="${day}"]`).addClass('active');
            });
        }

        toggleDateInput();

        $('#reminderModal').modal('show');
    }

    async function saveReminder() {
        const id = document.getElementById('reminderId').value;
        const title = document.getElementById('title').value;
        const frequency = document.getElementById('frequency').value;

        if (!title) {
            toastr.warning('請輸入標題');
            return;
        }

        // Collect Weekdays
        let weekdays = [];
        if (frequency === 'weekly') {
            $('.weekday-btn.active').each(function () {
                weekdays.push(parseInt($(this).data('day')));
            });
            if (weekdays.length === 0) {
                toastr.warning('請至少選擇一天');
                return;
            }
        }

        const payload = {
            title: title,
            description: document.getElementById('description').value,
            remind_time: document.getElementById('remindTime').value,
            remind_date: document.getElementById('remindDate').value,
            frequency: frequency,
            weekdays: weekdays
            // notify_method: removed, will use backend fallback based on UserSettings
        };

        const url = id ? `/reminders/${id}/edit` : '/reminders/add';

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();

            if (result.success) {
                toastr.success(result.message);
                $('#reminderModal').modal('hide');
                setTimeout(() => location.reload(), 500);
            } else {
                toastr.error(result.error);
            }
        } catch (e) {
            console.error(e);
            toastr.error('發生錯誤');
        }
    }

    async function deleteReminder(id) {
        if (!confirm('確定要刪除此提醒嗎？')) return;

        try {
            const res = await fetch(`/reminders/${id}/delete`, { method: 'POST' });
            if (res.ok) {
                toastr.success('已刪除');
                document.getElementById(`card-${id}`).remove();
            } else {
                toastr.error('刪除失敗');
            }
        } catch (e) {
            toastr.error('發生錯誤');
        }
    }

    async function toggleReminder(id) {
        try {
            const res = await fetch(`/reminders/${id}/toggle`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                const card = document.getElementById(`card-${id}`);
                if (data.is_active) {
                    card.classList.remove('inactive');
                    toastr.success('提醒已開啟');
                } else {
                    card.classList.add('inactive');
                    toastr.info('提醒已關閉');
                }
            }
        } catch (e) {
            console.error(e);
            toastr.error('操作失敗');
        }
    }
</script>
{% endblock %}