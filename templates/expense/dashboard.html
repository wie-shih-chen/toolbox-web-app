{% extends "base.html" %}

{% block title %}è¨˜å¸³ç®¡å®¶ - å·¥å…·ç®± Web{% endblock %}
{% block page_title %}ğŸ’³ è¨˜å¸³æ§åˆ¶å°{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/expense.css') }}">
{% endblock %}

{% block content %}
<!-- Horizontal Navigation Bar -->
<div class="salary-nav">
    <a href="{{ url_for('expense.today') }}"
        class="salary-nav-item {% if request.endpoint == 'expense.today' %}active{% endif %}">
        ğŸ“… æœ¬æ—¥è¨˜å¸³
    </a>
    <a href="{{ url_for('expense.index') }}"
        class="salary-nav-item {% if request.endpoint == 'expense.index' %}active{% endif %}">
        ğŸ“Š æœ¬é€±æœŸ
    </a>
    <a href="{{ url_for('expense.history') }}"
        class="salary-nav-item {% if request.endpoint == 'expense.history' %}active{% endif %}">
        ğŸ“œ æ­·å²
    </a>
    <a href="{{ url_for('expense.settings') }}"
        class="salary-nav-item {% if request.endpoint == 'expense.settings' %}active{% endif %}">
        âš™ï¸ è¨­å®š
    </a>
</div>

<div class="expense-dashboard" data-start-date="{{ start_date }}" data-end-date="{{ end_date }}">

    <!-- Summary Highlighting -->
    <div class="expense-summary-grid">
        <div class="expense-summary-card glass">
            <span class="label">æœ¬æœŸç¸½æ”¯å‡º (10è™Ÿèµ·)</span>
            <span class="value highlight" id="totalExpense">$0</span>
        </div>
        <div class="expense-summary-card glass">
            <span class="label">æœ¬æœˆé ç®—å‰©é¤˜</span>
            <div class="budget-progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="budgetProgress" style="width: 0%"></div>
                </div>
                <span class="value" id="remainingBudget">$10,000</span>
            </div>
        </div>
    </div>

    <!-- Period View Control -->
    <div class="period-header" style="flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px 20px;">
        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
            <span class="period-label">
                å¸³å‹™é€±æœŸï¼š<span id="periodDisplayTitle" style="color: var(--accent-color); font-weight: 700;">{{ start_date
                    }} ~ {{ end_date }}</span>
            </span>
            <div class="nav-controls">
                <button class="btn btn-secondary btn-sm" id="prevPeriodBtn">â—€</button>
                <button class="btn btn-secondary btn-sm" id="nextPeriodBtn">â–¶</button>
            </div>
        </div>
        <div id="weekRangeBar"
            style="font-size: 0.85rem; color: var(--text-secondary); background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px;">
            æœ¬é€±å€é–“ï¼š<span id="weekDisplayRange" style="color: white; font-weight: 500;">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <!-- Local Navigation Bar (Contextual) -->
    <div id="localNav" class="local-drilldown-nav hidden"
        style="margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;">
        <div id="navBackButton" class="back-button">
            <span class="material-icons">arrow_back_ios</span>
            <span id="backButtonText">è¿”å›</span>
        </div>
        <div id="levelTitle" style="font-weight: 600; font-size: 1.1rem; color: var(--accent-color);"></div>
        <div style="width: 60px;"></div> <!-- Spacer for centering -->
    </div>

    <!-- Hierarchical Transition Viewport -->
    <div class="drill-down-viewport">
        <div id="levelContainer" class="level-container level-weeks">
            <!-- Level 1: Weekly Overview -->
            <div id="weeklyLevel" class="list-level">
                <h3 class="section-title">é€±æœŸæ¦‚è¦½ (é€±ä¸€è‡³é€±æ—¥)</h3>
                <div id="weeklyList" class="weekly-grid-summary">
                    <div class="loading-placeholder">æ•¸æ“šåˆ†æä¸­...</div>
                </div>
            </div>

            <!-- Level 2: Daily Breakdown -->
            <div id="dailyLevel" class="list-level">
                <h3 class="section-title">æ¯æ—¥æ”¯å‡ºçµ±è¨ˆ</h3>
                <div id="dailyList" class="daily-grid-summary"></div>
            </div>

            <!-- Level 3: Record Detail -->
            <div id="recordLevel" class="list-level">
                <h3 class="section-title">è©³ç´°æ¶ˆè²»æ¸…å–®</h3>
                <div id="expenseList" class="expense-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Expense Modal -->
<div id="expenseModal" class="modal">
    <div class="modal-content glass">
        <div class="modal-header">
            <h3 id="modalTitle">æ–°å¢æ”¯å‡º</h3>
            <span class="close-modal" id="closeExpenseModalBtn">&times;</span>
        </div>
        <div class="modal-body">
            <form id="expenseForm">
                <input type="hidden" name="id" id="expenseId">

                <div class="form-group">
                    <label>é …ç›®åç¨±</label>
                    <input type="text" name="note" id="expenseNote" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€æ·é‹..." required>
                    <div class="quick-tags" id="mealQuickTags">
                        <div class="tag-pill" data-value="æ—©é¤">ğŸ³ æ—©é¤</div>
                        <div class="tag-pill" data-value="åˆé¤">ğŸ± åˆé¤</div>
                        <div class="tag-pill" data-value="æ™šé¤">ğŸœ æ™šé¤</div>
                        <div class="tag-pill" data-value="å®µå¤œ">ğŸ¢ å®µå¤œ</div>
                        <div class="tag-pill" data-value="é£²æ–™">â˜• é£²æ–™</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>é‡‘é¡ (NTD)</label>
                        <input type="number" name="amount" id="expenseAmount" placeholder="è¼¸å…¥é‡‘é¡" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>é¡åˆ¥</label>
                        <select name="category" id="expenseCategory">
                            <option value="é£²é£Ÿ" selected>ğŸ½ï¸ é£²é£Ÿ</option>
                            <option value="è¡£è‘—">ğŸ‘• è¡£è‘—</option>
                            <option value="å±…ä½">ğŸ  å±…ä½</option>
                            <option value="äº¤é€š">ğŸšŒ äº¤é€š</option>
                            <option value="æ•™è‚²">ğŸ“– æ•™è‚²</option>
                            <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="date-time-row">
                        <div class="date-icon-box">
                            <span class="material-icons">calendar_today</span>
                        </div>
                        <span class="date-label">Date</span>
                        <div class="pills-container">
                            <input type="date" id="expenseDate" class="input-pill" required>
                            <input type="time" id="expenseTime" class="input-pill" required>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-danger hidden" id="deleteExpenseBtn">åˆªé™¤</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜ç´€éŒ„</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/expense.js') }}"></script>
{% endblock %}