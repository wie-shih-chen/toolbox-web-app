<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}å·¥å…·ç®± Web{% endblock %}</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Main CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- jQuery (loaded early to prevent ReferenceError) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap JS (for tooltips and other components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .nav-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 12px;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <div class="container">
        <nav class="nav-bar glass">
            <a href="{{ url_for('main.index') }}" class="nav-brand">
                <span class="material-icons">home_repair_service</span>
                å·¥å…·ç®± Web
            </a>

            <div class="nav-links">
                {% if current_user.is_authenticated %}
                <div class="nav-user-info">
                    <div class="nav-avatar">
                        {% if current_user.avatar_type == 'upload' %}
                        <img src="{{ url_for('static', filename='uploads/avatars/' + current_user.avatar_val) }}"
                            style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        {{ current_user.avatar_val if current_user.avatar_val != 'default' else 'ğŸ‘¤' }}
                        {% endif %}
                    </div>
                    <span class="user-greeting" style="font-size: 0.9rem;">{{ current_user.username }}</span>
                </div>
                <a href="{{ url_for('auth.settings') }}" class="nav-link" title="è¨­å®š">
                    <span class="material-icons" style="font-size: 20px;">settings</span>
                </a>
                <a href="{{ url_for('auth.logout') }}" class="nav-link">ç™»å‡º</a>
                {% else %}
                <a href="{{ url_for('auth.login') }}" class="nav-link">ç™»å…¥</a>
                <a href="{{ url_for('auth.register') }}" class="nav-link">è¨»å†Š</a>
                {% endif %}
            </div>
        </nav>

        <script>
            // Initialize Bootstrap Tooltips globally
            $(function () {
                $('[data-toggle="tooltip"]').tooltip();
            })
        </script>

        {% block extra_js %}{% endblock %}

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-bottom-nav">
            <a href="{{ url_for('main.index') }}"
                class="mobile-nav-item {% if request.endpoint == 'main.index' %}active{% endif %}">
                <span class="material-icons">home</span>
                <span class="nav-text">é¦–é </span>
            </a>
            <a href="{{ url_for('salary.index') }}"
                class="mobile-nav-item {% if 'salary' in request.endpoint %}active{% endif %}">
                <span class="material-icons">payments</span>
                <span class="nav-text">è–ªè³‡</span>
            </a>
            <a href="{{ url_for('ntut.calendar') }}"
                class="mobile-nav-item {% if 'ntut' in request.endpoint %}active{% endif %}">
                <span class="material-icons">school</span>
                <span class="nav-text">åŒ—ç§‘</span>
            </a>
            <a href="{{ url_for('expense.today') }}"
                class="mobile-nav-item {% if 'expense' in request.endpoint %}active{% endif %}">
                <span class="material-icons">account_balance_wallet</span>
                <span class="nav-text">è¨˜å¸³</span>
            </a>

        </nav>
        <!-- Feature Introduction Modal (Custom Implementation) -->
        <div class="modal" id="introModal" style="display: none;">
            <div class="modal-content glass"
                style="max-width: 450px; text-align: center; position: relative; overflow: hidden; padding: 0;">

                <!-- Custom Styles for Intro -->
                <style>
                    .intro-slide {
                        display: none;
                        flex-direction: column;
                        align-items: center;
                        padding: 40px 30px;
                        animation: fadeInSlide 0.4s ease;
                    }

                    .intro-slide.active {
                        display: flex;
                    }

                    .intro-icon {
                        font-size: 4rem;
                        margin-bottom: 2rem;
                        filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.2));
                        animation: floatIcon 3s ease-in-out infinite;
                    }

                    .intro-title {
                        font-size: 1.5rem;
                        font-weight: 700;
                        margin-bottom: 1rem;
                        color: white;
                    }

                    .intro-text {
                        color: var(--text-secondary);
                        line-height: 1.6;
                        font-size: 1rem;
                        margin-bottom: 20px;
                    }

                    .intro-dots {
                        display: flex;
                        justify-content: center;
                        gap: 8px;
                        margin-bottom: 20px;
                    }

                    .intro-dot {
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.2);
                        transition: all 0.3s;
                    }

                    .intro-dot.active {
                        background: var(--accent-color);
                        width: 24px;
                        border-radius: 4px;
                    }

                    .intro-actions {
                        padding: 20px;
                        border-top: 1px solid rgba(255, 255, 255, 0.1);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        background: rgba(0, 0, 0, 0.2);
                    }

                    @keyframes floatIcon {

                        0%,
                        100% {
                            transform: translateY(0);
                        }

                        50% {
                            transform: translateY(-10px);
                        }
                    }

                    @keyframes fadeInSlide {
                        from {
                            opacity: 0;
                            transform: translateX(10px);
                        }

                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                </style>

                <!-- Slides -->
                <div id="slide1" class="intro-slide active">
                    <div class="intro-icon">ğŸ‘‹</div>
                    <div class="intro-title">æ­¡è¿ä½¿ç”¨å·¥å…·ç®± Web</div>
                    <div class="intro-text">
                        é€™è£¡æ•´åˆäº†è–ªæ°´è¨ˆç®—ã€è¨˜å¸³ç®¡å®¶èˆ‡æ ¡åœ’è³‡è¨Šï¼Œ<br>æ˜¯æ‚¨æ—¥å¸¸ç”Ÿæ´»èˆ‡å­¸ç¿’çš„æœ€ä½³åŠ©æ‰‹ã€‚
                    </div>
                </div>

                <div id="slide2" class="intro-slide">
                    <div class="intro-icon">ğŸ’°</div>
                    <div class="intro-title">æ’ç­èˆ‡è¨˜å¸³</div>
                    <div class="intro-text">
                        ç²¾æº–æŒæ¡è²¡å‹™ç‹€æ³ã€‚<br>è¼¸å…¥æ’ç­è‡ªå‹•è¨ˆç®—é ä¼°è–ªè³‡ï¼Œ<br>ä¸¦é€éé ç®—æ¢æ§åˆ¶æ¯æœˆèŠ±è²»ã€‚
                    </div>
                </div>

                <div id="slide3" class="intro-slide">
                    <div class="intro-icon">ğŸ’¬</div>
                    <div class="intro-title">æ™ºæ…§é€šçŸ¥</div>
                    <div class="intro-text">
                        ç¶å®š LINE å®˜æ–¹å¸³è™Ÿï¼Œ<br>æ¯æ—¥æ¥æ”¶è²¡å‹™æ‘˜è¦ï¼Œ<br>æ¯æœˆè‡ªå‹•å¯„é€æ”¶æ”¯å ±è¡¨ã€‚
                    </div>
                </div>

                <div id="slide4" class="intro-slide">
                    <div class="intro-icon">ğŸ’¾</div>
                    <div class="intro-title">è³‡æ–™è‡ªä¸»</div>
                    <div class="intro-text">
                        æ‚¨çš„è³‡æ–™æ‚¨åšä¸»ã€‚<br>éš¨æ™‚åŒ¯å‡º Excel å‚™ä»½ï¼Œ<br>æˆ–åœ¨è¨­å®šä¸­é‡ç½®ç‰¹å®šæ¨¡çµ„é‡æ–°é–‹å§‹ã€‚
                    </div>
                </div>

                <!-- Dots -->
                <div class="intro-dots">
                    <span class="intro-dot active" id="dot1"></span>
                    <span class="intro-dot" id="dot2"></span>
                    <span class="intro-dot" id="dot3"></span>
                    <span class="intro-dot" id="dot4"></span>
                </div>

                <!-- Controls -->
                <div class="intro-actions">
                    <button class="btn btn-secondary" onclick="closeIntro()"
                        style="font-size: 0.9rem; padding: 8px 16px;">è·³é</button>
                    <button class="btn btn-primary" id="nextIntroBtn" onclick="nextIntro()">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>

        <script>
            let currentSlide = 1;
            const totalSlides = 4;

            function updateIntroUI() {
                // Hide all slides
                document.querySelectorAll('.intro-slide').forEach(el => el.classList.remove('active'));
                // Show current
                document.getElementById('slide' + currentSlide).classList.add('active');

                // Update dots
                document.querySelectorAll('.intro-dot').forEach(el => el.classList.remove('active'));
                document.getElementById('dot' + currentSlide).classList.add('active');

                // Update Button Text
                const btn = document.getElementById('nextIntroBtn');
                if (currentSlide === totalSlides) {
                    btn.innerHTML = 'é–‹å§‹ä½¿ç”¨ ğŸš€';
                    btn.onclick = closeIntro;
                } else {
                    btn.innerHTML = 'ä¸‹ä¸€æ­¥';
                    btn.onclick = nextIntro;
                }
            }

            function nextIntro() {
                if (currentSlide < totalSlides) {
                    currentSlide++;
                    updateIntroUI();
                }
            }

            function openIntro() {
                currentSlide = 1;
                updateIntroUI();
                document.getElementById('introModal').style.display = 'flex';
            }

            function closeIntro() {
                document.getElementById('introModal').style.display = 'none';
                localStorage.setItem('toolbox_intro_seen', 'true');
            }

            document.addEventListener('DOMContentLoaded', function () {
                // Check if user has seen the intro
                if (!localStorage.getItem('toolbox_intro_seen') && window.location.pathname === '/') {
                    setTimeout(openIntro, 500);
                    // Mark as seen immediately so it doesn't pop up again even if they refresh
                    localStorage.setItem('toolbox_intro_seen', 'true');
                }
            });

            // Close on click outside
            document.getElementById('introModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closeIntro();
                }
            });
        </script>

        <!-- Chart.js for data visualization -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

</body>

</html>